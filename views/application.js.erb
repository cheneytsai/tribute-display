/****** Main Execution Thread ********/

var scheme   = "<%= @scheme %>";
var uri      = scheme + window.document.location.host + "/";
var ws       = new WebSocket(uri);

var STARTING_LITERS_PUMPED = window.document.location.href.split('?pumped=')[1] || 0;

var PEOPLE_SERVED_BY_ONE_LITER = 20;


$(document).ready(function() {

  od1 = new Odometer({
    el: document.querySelector('#served-count'),
    duration: 5000,
  });

  od2 = new Odometer({
    el: document.querySelector('#pumped-count'),
    duration: 5000,
  });

});



/******** End Main Thread *********/

// Callback for WebSocket Response
ws.onmessage = function(message) {
  var data = JSON.parse(message.data);
  //console.log(data);
    var people_served = parseInt((data.ml_pumped/1000 + parseFloat(STARTING_LITERS_PUMPED)) * PEOPLE_SERVED_BY_ONE_LITER);
    var liters_pumped = (parseFloat(data.ml_pumped/1000) + parseFloat(STARTING_LITERS_PUMPED)).toFixed(1);

    window.requestAnimationFrame(updateCounter);

    function updateCounter() {
      od1.update(people_served);
      od2.update(liters_pumped);
    }

    
};

function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}





